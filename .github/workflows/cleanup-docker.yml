name: Cleanup Docker Disk Space

on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Clean up Docker on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ“Š Disk usage before cleanup:"
            df -h /
            
            echo ""
            echo "ğŸ—‘ï¸  Removing stopped containers..."
            docker container prune -f
            
            echo "ğŸ—‘ï¸  Removing dangling images..."
            docker image prune -f
            
            echo "ğŸ—‘ï¸  Removing unused images (keep last 3 tags)..."
            docker images 851725492026.dkr.ecr.us-east-1.amazonaws.com/ytdl --format "{{.ID}} {{.Tag}}" | tail -n +4 | awk '{print $1}' | xargs -r docker rmi -f || true
            
            echo "ğŸ—‘ï¸  Removing unused volumes..."
            docker volume prune -f
            
            echo "ğŸ—‘ï¸  Removing build cache..."
            docker builder prune -f
            
            echo ""
            echo "ğŸ“Š Disk usage after cleanup:"
            df -h /
            
            echo ""
            echo "ğŸ³ Remaining Docker images:"
            docker images
