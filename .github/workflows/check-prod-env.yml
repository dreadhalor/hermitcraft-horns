name: Check Production Environment
on:
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check environment variables in production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üîç Checking production environment..."
            cd /home/ec2-user
            
            echo ""
            echo "üìã Docker compose file environment section:"
            grep -A 10 "environment:" docker-compose.yml | head -20
            
            echo ""
            echo "üîë Checking if secrets are loaded in shell:"
            export NORDVPN_USERNAME=$(aws secretsmanager get-secret-value --region us-east-1 --secret-id hermitcraft-horns/ytdl/nordvpn-username --query SecretString --output text)
            export NORDVPN_PASSWORD=$(aws secretsmanager get-secret-value --region us-east-1 --secret-id hermitcraft-horns/ytdl/nordvpn-password --query SecretString --output text)
            echo "Shell NORDVPN_USERNAME length: ${#NORDVPN_USERNAME}"
            echo "Shell NORDVPN_PASSWORD length: ${#NORDVPN_PASSWORD}"
            
            echo ""
            echo "üê≥ Checking gluetun container environment:"
            docker exec gluetun printenv | grep -i "vpn\|nord\|open" | grep -v PASSWORD || echo "No VPN env vars found in container"
            
            echo ""
            echo "üìä Gluetun container inspect (environment):"
            docker inspect gluetun | jq '.[0].Config.Env' | grep -i "vpn\|nord\|open" | head -10
