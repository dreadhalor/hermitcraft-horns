name: Test VPN Credentials (Extended)
on:
  workflow_dispatch:

jobs:
  test-vpn:
    runs-on: ubuntu-latest
    steps:
      - name: Extended VPN test on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 3m
          script: |
            echo "ðŸ” Testing NordVPN credentials (extended)..."
            
            # Load secrets
            export NORDVPN_USERNAME=$(aws secretsmanager get-secret-value --region us-east-1 --secret-id hermitcraft-horns/ytdl/nordvpn-username --query SecretString --output text)
            export NORDVPN_PASSWORD=$(aws secretsmanager get-secret-value --region us-east-1 --secret-id hermitcraft-horns/ytdl/nordvpn-password --query SecretString --output text)
            
            echo "Testing with credentials:"
            echo "Username: ${NORDVPN_USERNAME:0:10}***"
            echo "Password: ${NORDVPN_PASSWORD:0:10}***"
            
            # Test with a minimal gluetun container
            echo ""
            echo "ðŸ§ª Starting test container..."
            docker run -d --rm \
              --name gluetun-extended-test \
              --cap-add=NET_ADMIN \
              -e VPN_SERVICE_PROVIDER=nordvpn \
              -e OPENVPN_USER="$NORDVPN_USERNAME" \
              -e OPENVPN_PASSWORD="$NORDVPN_PASSWORD" \
              -e SERVER_COUNTRIES="United States" \
              qmcgaw/gluetun:latest
            
            echo "â³ Waiting 60 seconds for full connection attempt..."
            sleep 60
            
            echo ""
            echo "ðŸ“‹ Full container logs:"
            docker logs gluetun-extended-test 2>&1
            
            echo ""
            echo "ðŸ§¹ Cleaning up..."
            docker stop gluetun-extended-test || true
