name: Test VPN Credentials
on:
  workflow_dispatch:

jobs:
  test-vpn:
    runs-on: ubuntu-latest
    steps:
      - name: Test NordVPN credentials on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ðŸ” Testing NordVPN credentials..."
            
            # Load secrets
            export NORDVPN_USERNAME=$(aws secretsmanager get-secret-value --region us-east-1 --secret-id hermitcraft-horns/ytdl/nordvpn-username --query SecretString --output text)
            export NORDVPN_PASSWORD=$(aws secretsmanager get-secret-value --region us-east-1 --secret-id hermitcraft-horns/ytdl/nordvpn-password --query SecretString --output text)
            
            echo "Username length: ${#NORDVPN_USERNAME}"
            echo "Password length: ${#NORDVPN_PASSWORD}"
            echo "Username: ${NORDVPN_USERNAME:0:10}***"
            echo "Password: ${NORDVPN_PASSWORD:0:10}***"
            
            # Test with a minimal gluetun container
            echo ""
            echo "ðŸ§ª Starting test container..."
            docker run -d --rm \
              --name gluetun-test \
              --cap-add=NET_ADMIN \
              -e VPN_SERVICE_PROVIDER=nordvpn \
              -e OPENVPN_USER="$NORDVPN_USERNAME" \
              -e OPENVPN_PASSWORD="$NORDVPN_PASSWORD" \
              -e SERVER_COUNTRIES="United States" \
              -e LOG_LEVEL=debug \
              qmcgaw/gluetun:latest
            
            echo "â³ Waiting 25 seconds for connection attempt..."
            sleep 25
            
            echo ""
            echo "ðŸ“‹ Container logs:"
            docker logs gluetun-test 2>&1 | tail -50
            
            echo ""
            echo "ðŸ§¹ Cleaning up..."
            docker stop gluetun-test || true
